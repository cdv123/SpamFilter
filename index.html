<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <link rel="stylesheet" href="style.css" />
    <meta charset="UTF-8">
    <!-- pyscript library-->
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- d3 library-->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <title>Analysis of different methods for spam classification</title>
    <py-config>
        packages= ["numpy","matplotlib"]
        [[fetch]]
        from = "./"
        files =["numpyNetwork.py", "word2vec.py", "simplifyDataset.py", "numpyNetwork.py", "oneHot.py","naiveBayesMethod.py","neuralNetwork.py"]
    </py-config>
</head>
<body>
    <h1>Spam Detection</h1>
    <label for="msg-input" id = "msg-label">Input spam (or ham) message here:</label>
    <input type="text" id = "msg-input">
    <button onclick="showX()" id = "Evaluate">Evaluate Message</button>
    <div id = "modal-results">
        <div id="my_dataviz"></div>
        <button class = "close-btn" id = "close-results">X</button>
        <div id = "results-chart"></div>
    </div> 
    <button id = "settings-btn"> Settings</button>
    <div id = "plot"> </div>
    <div id = "config">
        <button class = "close-btn" id = "close-config">X</button>
        <p class = "line">
            <p class = "model">Naive Bayes Model:</p>
            <p class = "epoch-num">Prior spam probability</p>
            <input class ="number-input" type="number" name="" value="0.50" min ="0" max = "1" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <p class = "setting">Words Used</p>
            <input class ="number-input" type="number" name="" value="1000" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <button id = "btn-naive-bayes" class = "confirm-settings">Confirm and Retrain Naive Bayes</button>
        </p>
        <p class = "line">
            <p class = "model">One-Hot Model:</p>
            <p class = "epoch-num">Vector Size:</p>
            <input class ="number-input" type="number" name="" value="100" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <p class = "epoch-num">Number of epochs:</p>
            <input class ="number-input" type="number" name="" value="20" min = "0" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <p class = "setting">Learning Rate:</p>
            <input class = "number-input" type="number" name="" value="0.03" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <button id = "btn-one-hot" class = "confirm-settings">Confirm and Retrain One-Hot</button>
        </p>
        <p class = "line">
            <p class = "model">Word2Vec Model:</p>
            <p class = "epoch-num">Number of epochs:</p>
            <input class = "number-input" type="number" name="" value="20" min = "0" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <p class = "setting">Learning Rate:</p>
            <input class = "number-input" type="number" name="" value="0.03" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <p class = "add-hidden">Add hidden layer</p>
            <input id = "checkbox-word2vec" class = "hidden-layer" type="checkbox" name="" value="">
            <p class = "hidden-nodes-num hidden-word2vec">Number of nodes in hidden layer:</p>
            <input class = "hidden-nodes hidden-word2vec" type="" name="" value="9" onkeydown="this.style.width = ((this.value.length + 1) * 9) + 'px';">
            <button id = "btn-word2vec" class = "confirm-settings">Confirm and Retrain Word2Vec</button>
        </p>
    </div>
    <py-script> 
    import numpy as np
    from word2vec import sentenceEmbedding, useEmbedding, messageEmbedding
    from oneHot import oneHotEncode,getMostCommonWords,oneHotEncode2
    from numpyNetwork import neuralNetwork,getOutput, sigmoid
    from simplifyDataset import loadSMS,convertSpamToBinary,loadMessage
    from naiveBayesMethod import trainModel, analyseMsg
    from pyodide.http import open_url
    from pyodide.http import to_js
    import js
    from pyodide.ffi import create_proxy
    import matplotlib.pyplot as plt
    from neuralNetwork import NeuralNetwork
    trainingText = open_url("https://raw.githubusercontent.com/cdv123/SpamFilter/webversion/Dataset/SMSSpamCollection.txt")
    customEmbedding = open_url("https://raw.githubusercontent.com/cdv123/SpamFilter/webversion/Dataset/customEmbedding.txt")
    valText = open_url("https://raw.githubusercontent.com/cdv123/SpamFilter/webversion/Dataset/SMSVal.txt")
    trainingText = trainingText.read()
    valText = valText.read()
    customEmbedding = customEmbedding.read()
    trainingData,spamData = loadSMS(trainingText)
    valData,valSpam = loadSMS(valText)
    spamData = convertSpamToBinary(spamData)
    spamData2 = spamData[:]
    valSpam = convertSpamToBinary(valSpam)
    valSpam2 = valSpam[:]
    vector_size = 100
    embeddingDict = useEmbedding(customEmbedding)
    word2vec_model = NeuralNetwork(1)
    one_hot_model = NeuralNetwork(1)
    wordProbHam,wordProbSpam = None,None
    mostCommonWords = None
    priorSpam = 0.5
    def oneHotTrain(trainingData,spamData,valData,valSpam,vector_size,epochs,lr,plot_bool):
        global mostCommonWords
        mostCommonWords = getMostCommonWords(trainingData,vector_size)
        oneHotTrain = list(oneHotEncode(trainingData,mostCommonWords).values())
        oneHotVal = list(oneHotEncode(valData,mostCommonWords).values())
        global one_hot_model
        one_hot_model.train_network(epochs,oneHotTrain,spamData,lr,oneHotVal,valSpam)
        if plot_bool:
            plot(word2vec_model.error,word2vec_model.error_val,epochs)
    def naiveBayesTrain(trainingData,spamData,wordNum,inputSpamPrior):
        global priorSpam
        priorSpam = inputSpamPrior
        resultArr = trainModel(trainingData,spamData,wordNum)
        global wordProbHam 
        wordProbHam= resultArr[0]
        global wordProbSpam
        wordProbSpam = resultArr[1]
    def word2vecTrain(trainingData,spamData,valData,valSpam,epochs,lr,plot_bool):
        trainSentences = sentenceEmbedding(trainingData,spamData,embeddingDict,100)
        valSentences = sentenceEmbedding(valData,valSpam,embeddingDict,100)
        global word2vec_model
        word2vec_model.train_network(epochs,trainSentences,spamData,lr,valSentences,valSpam)
        if plot_bool:
            plot(word2vec_model.error,word2vec_model.error_val,epochs)
    def useOneHot(model,message):
        global mostCommonWords
        message = loadMessage(message)
        oneHotData = oneHotEncode2(message,mostCommonWords)
        return sigmoid(getOutput(oneHotData,model.weight_matrix,model.bias_vector))
    def useWord2Vec(model,message):
        message = loadMessage(message)
        wordVector = messageEmbedding(message,embeddingDict)
        return sigmoid(getOutput(wordVector,model.weight_matrix,model.bias_vector))
            
    def plt_style():
        plt.rcParams['figure.autolayout'] = True
        plt.rcParams['figure.figsize'] = [6.4, 4.8]
        plt.rcParams['font.family'] ='serif'
        plt.rcParams['font.size'] = 12
        plt.rcParams['xtick.direction'] = 'in'
        plt.rcParams['ytick.direction'] = 'in'
        plt.rcParams['axes.linewidth'] = 1.0
        plt.rcParams['errorbar.capsize'] = 6
        plt.rcParams['lines.markersize'] = 6
        plt.rcParams['lines.markerfacecolor'] = 'white'
        plt.rcParams['mathtext.fontset'] = 'cm'
    def plot(error,error_val,epochs):
        plt_style()
        fig,ax = plt.subplots()
        ax.set_xlabel('Epoch')
        ax.set_ylabel('Training Loss')
        ax.plot(range(epochs),error)
        ax.plot(range(epochs),error_val)
        display(fig,target="plot")
    naiveBayesTrain(trainingData,spamData,1000,0.5)
    word2vecTrain(trainingData,spamData2,valData,valSpam,20,0.003,False)
    oneHotTrain(trainingData,spamData,valData,valSpam,vector_size,20,0.003,False)
    </py-script>
    <script src = "script.js"></script>
</body>
</html>